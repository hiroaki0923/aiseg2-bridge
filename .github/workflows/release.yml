name: Release HACS Integration

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  validate-hacs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: HACS validation
        uses: hacs/action@main
        with:
          category: "integration"

  create-release:
    needs: validate-hacs
    if: always()  # Run even if HACS validation fails
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            echo "No previous tag found, including all commits"
            CHANGELOG=$(git log --pretty=format:"- %s" --reverse)
          else
            echo "Previous tag: $PREV_TAG"
            CHANGELOG=$(git log --pretty=format:"- %s" ${PREV_TAG}..HEAD --reverse)
          fi
          
          # Store in GitHub environment file with proper escaping
          echo "CHANGELOG<<EOF" >> $GITHUB_ENV
          echo "$CHANGELOG" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## Home Assistant Custom Component
            
            This release is available as a Home Assistant Custom Component:
            
            ### Installation via HACS (Custom Repository)
            1. Add this repository to HACS as a custom repository: `https://github.com/hiroaki0923/aiseg2-bridge`
            2. Category: Integration
            3. Install "AiSEG2 Bridge" integration
            4. Restart Home Assistant
            5. Add the integration via Settings ‚Üí Devices & Services
            
            ### Manual Installation
            1. Download the latest release
            2. Extract `custom_components/aiseg2_bridge` to your Home Assistant `custom_components` directory
            3. Restart Home Assistant
            4. Add the integration via Settings ‚Üí Devices & Services
            
            ### HACS Validation Status
            - ‚úÖ Repository metadata, topics, and manifest validation passed
            - ‚ÑπÔ∏è  Brands validation skipped (expected for custom integrations)
            - üìã This integration is ready for use as a custom component
            
            ## Changes
            
            ${{ env.CHANGELOG }}
            
            ## Documentation
            
            See the [README](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/README.md) for installation and usage instructions.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}