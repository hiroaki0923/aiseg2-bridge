#!/bin/bash
#
# Git pre-push hook to automatically update manifest.json version
# when pushing version tags
#

# Enable strict error handling
set -e

# Read input from stdin (local_ref local_sha remote_ref remote_sha)
while read local_ref local_sha remote_ref remote_sha; do
    # Check if we're pushing a version tag
    if [[ "$remote_ref" =~ refs/tags/v([0-9]+\.[0-9]+\.[0-9]+) ]]; then
        VERSION="${BASH_REMATCH[1]}"
        MANIFEST_FILE="custom_components/aiseg2mqtt/manifest.json"
        
        echo "üè∑Ô∏è  Version tag detected: v${VERSION}"
        
        # Check if manifest.json exists
        if [[ ! -f "$MANIFEST_FILE" ]]; then
            echo "‚ùå Error: $MANIFEST_FILE not found!"
            exit 1
        fi
        
        # Get current version from manifest.json
        CURRENT_VERSION=$(grep '"version"' "$MANIFEST_FILE" | sed 's/.*"version": "\([^"]*\)".*/\1/')
        
        if [[ "$CURRENT_VERSION" == "$VERSION" ]]; then
            echo "‚úÖ manifest.json version already matches tag ($VERSION)"
        else
            echo "üîÑ Updating manifest.json version: $CURRENT_VERSION ‚Üí $VERSION"
            
            # Create backup
            cp "$MANIFEST_FILE" "$MANIFEST_FILE.backup"
            
            # Update version using sed (cross-platform compatible)
            if [[ "$OSTYPE" == "darwin"* ]]; then
                # macOS
                sed -i '' 's/"version": "[^"]*"/"version": "'$VERSION'"/' "$MANIFEST_FILE"
            else
                # Linux
                sed -i 's/"version": "[^"]*"/"version": "'$VERSION'"/' "$MANIFEST_FILE"
            fi
            
            # Verify the change
            NEW_VERSION=$(grep '"version"' "$MANIFEST_FILE" | sed 's/.*"version": "\([^"]*\)".*/\1/')
            if [[ "$NEW_VERSION" != "$VERSION" ]]; then
                echo "‚ùå Error: Failed to update version in manifest.json"
                mv "$MANIFEST_FILE.backup" "$MANIFEST_FILE"
                exit 1
            fi
            
            # Show the change
            echo "üìù Updated content:"
            grep -A 2 -B 2 '"version"' "$MANIFEST_FILE"
            
            # Stage and commit the change
            git add "$MANIFEST_FILE"
            git commit -m "Update manifest.json version to $VERSION

This commit was automatically generated by the pre-push hook when pushing tag v$VERSION.
"
            
            # Clean up backup
            rm -f "$MANIFEST_FILE.backup"
            
            echo "‚úÖ manifest.json updated and committed"
        fi
    fi
done

echo "üöÄ Pre-push checks completed successfully"